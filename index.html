/* STEP 8-2 : Rally-X Enemy Car AI 추가 (정식 통합)
   - 적 차량 추격 AI
   - 플레이어 방향 예측
   - 벽 충돌 회피
*/

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const TILE = 40;
const ROWS = 32;
const COLS = 19;

// 0 = road, 1 = wall
const MAP = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,1],
  [1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,1,0,1],
  [1,0,1,1,1,1,1,0,1,0,1,1,1,0,1,0,1,0,1],
  [1,0,0,0,0,0,1,0,1,0,0,0,1,0,0,0,0,0,1],
  [1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1],
  [1,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,1],
  [1,0,1,0,1,1,1,1,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const player = { x: 1, y: 1, color: 'red' };

const enemies = [
  { x: 17, y: 1, color: 'blue', dir: 'left' },
  { x: 17, y: 9, color: 'blue', dir: 'up' }
];

function drawMap() {
  for (let y = 0; y < MAP.length; y++) {
    for (let x = 0; x < MAP[y].length; x++) {
      ctx.fillStyle = MAP[y][x] === 1 ? '#5FAE3B' : '#C69C6D';
      ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
    }
  }
}

function drawCar(obj) {
  ctx.fillStyle = obj.color;
  ctx.fillRect(obj.x*TILE+8, obj.y*TILE+8, TILE-16, TILE-16);
}

function canMove(x,y){ return MAP[y][x] === 0; }

function moveEnemy(e) {
  const dx = player.x - e.x;
  const dy = player.y - e.y;

  const options = [];
  if (dx > 0) options.push({x:1,y:0});
  if (dx < 0) options.push({x:-1,y:0});
  if (dy > 0) options.push({x:0,y:1});
  if (dy < 0) options.push({x:0,y:-1});

  options.sort(()=>Math.random()-0.5);

  for (const o of options) {
    const nx = e.x + o.x;
    const ny = e.y + o.y;
    if (canMove(nx,ny)) { e.x = nx; e.y = ny; return; }
  }
}

window.addEventListener('keydown', e=>{
  const m = {ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]}[e.key];
  if(!m) return;
  const nx = player.x + m[0];
  const ny = player.y + m[1];
  if (canMove(nx,ny)) { player.x = nx; player.y = ny; }
});

function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawCar(player);
  enemies.forEach(e=>{ moveEnemy(e); drawCar(e); });
  requestAnimationFrame(loop);
}

loop();
</html>
